<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historia Scrimów</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Firebase SDK (compatibility version) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    .champion-icon { width: 24px; height: 24px; margin-right: 4px; vertical-align: middle; }
    .win { background-color: #d4edda; }
    .lose { background-color: #f8d7da; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo-section">
      <img src="logo.png" alt="Logo" class="logo" />
      <span class="site-name"></span>
    </div>
    <nav class="nav-links">
      <a href="index.html">STRONA GŁÓWNA</a>
      <a href="historia.html">HISTORIA GIER</a>
      <a href="#test3">test3</a>
      <a href="#test4">test4</a>
      <a href="#test5">test5</a>
    </nav>
  </header>

  <main>
    <h1>Historia Scrimów</h1>

    <section class="stats-summary">
      <div class="stats-item">Ilość scrimów: <span id="totalScrims">0</span></div>
      <div class="stats-item">Wygrane: <span id="wins">0</span></div>
      <div class="stats-item">Przegrane: <span id="losses">0</span></div>
      <div class="stats-item">% zwycięstw: <span id="winRate">0%</span></div>
    </section>

    <section class="add-scrim-form">
      <h2>Dodaj nowy Scrim</h2>
      <form id="scrimForm">
        <div class="form-group">
          <label for="scrimDate">Data:</label>
          <input type="date" id="scrimDate" required />
        </div>
        <div class="form-group">
          <label for="scrimResult">Wynik:</label>
          <select id="scrimResult" required>
            <option value="">Wybierz wynik</option>
            <option value="WIN">WIN</option>
            <option value="LOSE">LOSE</option>
          </select>
        </div>
        <div class="form-group">
          <label for="scrimTime">Czas Gry:</label>
          <input type="text" id="scrimTime" placeholder="np. 35:12" required />
        </div>

        <div class="form-group team-champions">
          <label>Nasze Postacie:</label>
          <input type="text" class="our-champion-input" placeholder="Top" required />
          <input type="text" class="our-champion-input" placeholder="Jungle" required />
          <input type="text" class="our-champion-input" placeholder="Mid" required />
          <input type="text" class="our-champion-input" placeholder="Adc" required />
          <input type="text" class="our-champion-input" placeholder="Support" required />
        </div>

        <div class="form-group team-champions">
          <label>Postacie Przeciwników:</label>
          <input type="text" class="enemy-champion-input" placeholder="Top" required />
          <input type="text" class="enemy-champion-input" placeholder="Jungle" required />
          <input type="text" class="enemy-champion-input" placeholder="Mid" required />
          <input type="text" class="enemy-champion-input" placeholder="Adc" required />
          <input type="text" class="enemy-champion-input" placeholder="Support" required />
        </div>

        <button type="submit">Dodaj Scrim</button>
      </form>
    </section>

    <section class="scrim-history">
      <h2>Poprzednie Scrimy</h2>
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Wynik</th>
            <th>Czas Gry</th>
            <th>Nasze Postacie</th>
            <th>Postacie Przeciwników</th>
            <th>Akcje</th>
          </tr>
        </thead>
        <tbody id="scrimTableBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // Konfiguracja Firebase (podmień na swoje dane z firebaseConfig)
    const firebaseConfig = {
      apiKey: "AIzaSyA4depHuFw3bJ3Uq2gjKeiW5umhjiKnJ40",
      authDomain: "acg-skrimy.firebaseapp.com",
      databaseURL: "https://acg-skrimy-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "acg-skrimy",
      storageBucket: "acg-skrimy.firebasestorage.app",
      messagingSenderId: "78237268518",
      appId: "1:78237268518:web:6b02118d081b4a49b384e7",
      measurementId: "G-6VDFPFX560"
    };

    // Inicjalizacja Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Elementy DOM
    const scrimForm = document.getElementById("scrimForm");
    const scrimTableBody = document.getElementById("scrimTableBody");
    const scrimDateInput = document.getElementById("scrimDate");
    const scrimResultInput = document.getElementById("scrimResult");
    const scrimTimeInput = document.getElementById("scrimTime");
    const ourChampionInputs = document.querySelectorAll(".our-champion-input");
    const enemyChampionInputs = document.querySelectorAll(".enemy-champion-input");

    // Statystyki
    const totalScrimsSpan = document.getElementById("totalScrims");
    const winsSpan = document.getElementById("wins");
    const lossesSpan = document.getElementById("losses");
    const winRateSpan = document.getElementById("winRate");

    // Data Dragon dla ikon
    const DDRAGON_VERSION = "14.22.1";
    const CHAMPION_IMAGE_BASE_URL = `http://ddragon.leagueoflegends.com/cdn/${DDRAGON_VERSION}/img/champion/`;
    const FALLBACK_ICON_URL = "https://via.placeholder.com/24x24?text=N/A";

    let scrimsData = [];

    // Mapowanie nazw championów na DataDragon
    const nameMap = {
      "aurelion sol": "AurelionSol",
      chogath: "Chogath",
      "dr. mundo": "DrMundo",
      drmundo: "DrMundo",
      kaisa: "Kaisa",
      kogmaw: "KogMaw",
      "lee sin": "LeeSin",
      "miss fortune": "MissFortune",
      "nunu & willump": "Nunu",
      nunu: "Nunu",
      "renata glasc": "Renata",
      renataglasc: "Renata",
      "tahm kench": "TahmKench",
      "twisted fate": "TwistedFate",
      "xin zhao": "XinZhao",
      belveth: "BelVeth",
      fiddlesticks: "Fiddlesticks",
      blitzcrank: "Blitzcrank",
      "master yi": "MasterYi",
      masteryi: "MasterYi",
      rengar: "Rengar",
      reksai: "RekSai",
      viego: "Viego",
      kled: "Kled",
      "jarvan iv": "JarvanIV",
      jarvaniv: "JarvanIV",
      "monkey king": "Wukong",
      wukong: "Wukong",
      velkoz: "Velkoz",
      ksante: "KSante",
    };

    // Funkcja do uzyskania URL ikonki
    function getChampionIconUrl(championName) {
      if (!championName) return FALLBACK_ICON_URL;
      let cleanedName = championName.trim().toLowerCase().replace(/'/g, "");

      let dataDragonName = nameMap[cleanedName];
      if (!dataDragonName) {
        // Jeśli nie w mapie, to próbujemy zamienić na CamelCase
        dataDragonName = cleanedName
          .split(" ")
          .map(w => w.charAt(0).toUpperCase() + w.slice(1))
          .join("");
      }
      return `${CHAMPION_IMAGE_BASE_URL}${dataDragonName}.png`;
    }

    // Aktualizacja statystyk
    function updateStats() {
      const totalScrims = scrimsData.length;
      const wins = scrimsData.filter(s => s.result === "WIN").length;
      const losses = scrimsData.filter(s => s.result === "LOSE").length;
      const winRate = totalScrims > 0 ? ((wins / totalScrims) * 100).toFixed(2) : 0;

      totalScrimsSpan.textContent = totalScrims;
      winsSpan.textContent = wins;
      lossesSpan.textContent = losses;
      winRateSpan.textContent = `${winRate}%`;
    }

    // Renderowanie tabeli
    function renderTable() {
      scrimTableBody.innerHTML = "";
      scrimsData.forEach(scrim => {
        const row = document.createElement("tr");
        row.className = scrim.result.toLowerCase();

        const ourChampionsHtml = scrim.our
          .split(",")
          .map(name => {
            const n = name.trim();
            if (!n) return "";
            const icon = getChampionIconUrl(n);
            return `<img src="${icon}" alt="${n}" title="${n}" class="champion-icon" onerror="this.onerror=null; this.src='${FALLBACK_ICON_URL}';">`;
          })
          .join("");

        const enemyChampionsHtml = scrim.enemy
          .split(",")
          .map(name => {
            const n = name.trim();
            if (!n) return "";
            const icon = getChampionIconUrl(n);
            return `<img src="${icon}" alt="${n}" title="${n}" class="champion-icon" onerror="this.onerror=null; this.src='${FALLBACK_ICON_URL}';">`;
          })
          .join("");

        row.innerHTML = `
          <td>${new Date(scrim.date.seconds * 1000).toLocaleDateString()}</td>
          <td>${scrim.result}</td>
          <td>${scrim.time}</td>
          <td>${ourChampionsHtml}</td>
          <td>${enemyChampionsHtml}</td>
          <td><button data-id="${scrim.id}" class="delete-btn">Usuń</button></td>
        `;

        scrimTableBody.appendChild(row);
      });
      updateStats();
    }

    // Dodanie scrimu do Firestore
    async function addScrim(scrim) {
      try {
        await db.collection("scrims").add(scrim);
      } catch (err) {
        console.error("Błąd dodawania scrimu:", err);
      }
    }

    // Usunięcie scrimu z Firestore
    async function deleteScrim(id) {
      try {
        await db.collection("scrims").doc(id).delete();
      } catch (err) {
        console.error("Błąd usuwania scrimu:", err);
      }
    }

    // Nasłuchiwanie na zmiany w kolekcji scrims (Realtime update)
    db.collection("scrims")
      .orderBy("date", "desc")
      .onSnapshot(snapshot => {
        scrimsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTable();
      });

    // Obsługa formularza dodawania scrimu
    scrimForm.addEventListener("submit", e => {
      e.preventDefault();

      // Pobranie wartości
      const dateValue = scrimDateInput.value;
      const resultValue = scrimResultInput.value;
      const timeValue = scrimTimeInput.value.trim();
      const ourChampions = Array.from(ourChampionInputs).map(i => i.value.trim()).join(",");
      const enemyChampions = Array.from(enemyChampionInputs).map(i => i.value.trim()).join(",");

      if (!dateValue || !resultValue || !timeValue || !ourChampions || !enemyChampions) {
        alert("Wypełnij wszystkie pola!");
        return;
      }

      // Data musi być timestamp Firestore (Date object)
      const dateTimestamp = firebase.firestore.Timestamp.fromDate(new Date(dateValue));

      // Obiekt scrimu
      const newScrim = {
        date: dateTimestamp,
        result: resultValue,
        time: timeValue,
        our: ourChampions,
        enemy: enemyChampions,
      };

      addScrim(newScrim);

      // Reset formularza
      scrimForm.reset();
    });

    // Obsługa usuwania scrimów - event delegation
    scrimTableBody.addEventListener("click", e => {
      if (e.target.classList.contains("delete-btn")) {
        const id = e.target.getAttribute("data-id");
        if (confirm("Na pewno usunąć ten scrim?")) {
          deleteScrim(id);
        }
      }
    });
  </script>
</body>
</html>
